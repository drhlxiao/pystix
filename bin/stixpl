#!/usr/bin/python3
# @author       : Hualin Xiao
# @date         : May. 11, 2021

import os
import sys

import time
import threading

currentdir = os.path.dirname(os.path.realpath(__file__))
parentdir = os.path.dirname(currentdir)
sys.path.append(parentdir)

from stix.pipeline import raw_pipeline as pd
from stix.analysis import goes_downloader as gd
from stix.analysis import flare_detection
#from stix.aspect import aspect_to_db as asp
from stix.fits import fits_creator
from stix.core import logger
from stix.core import config
logger = logger.get_logger()



def do_task():
    logger.info('Starting thread')
    pd.main()


# Define a function to check if the thread is running for more than 2 hours
def check_running_thread(thread):
    if not thread.is_alive():
        logger.info("pipeline not running, restarting...")
        start_thread()
        return
    else:
        if time.time() - thread.start_time > 7200: # 2 hours in seconds
            logger.warning("Thread has been running for more than 2 hours, restarting...")
            thread.kill()
            start_thread()

# Define a function to start the thread
def start_thread():
    thread = threading.Thread(target=do_task)
    thread.daemon = True
    thread.start_time = time.time()
    thread.kill = lambda: None
    thread.start()

    # Check the thread every 5 minutes
    while True:
        time.sleep(120) # 5 minutes in seconds
        check_running_thread(thread)

# Start the thread
if __name__ == '__main__':
    start_thread()

